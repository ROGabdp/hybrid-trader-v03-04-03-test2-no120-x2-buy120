#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
================================================================================
V4 Ê®°ÂûãË®ìÁ∑¥ËÖ≥Êú¨ - Ê®ôÊ∫ñÂÆåÊï¥ÁâàÊú¨ (Standard)
================================================================================
Êú¨ËÖ≥Êú¨Âü∑Ë°åÂÆåÊï¥ÁöÑ V4 Ë®ìÁ∑¥ÊµÅÁ®ãÔºö
1. Ê∏ÖÈô§ËàäÁöÑÁâπÂæµÂø´ÂèñÔºàÂº∑Âà∂Áî®Êñ∞ÁöÑ 30 Ê¨° MC Dropout Êé°Ê®£ÈáçÁÆóÔºâ
2. Âü∑Ë°åÈ†êË®ìÁ∑¥ (Pre-training)
3. Âü∑Ë°åÂæÆË™ø (Fine-tuning) - Ê®ôÊ∫ñÂÆåÊï¥Ê≠•Êï∏

Ëàá V3 ÁöÑÂ∑ÆÁï∞Ôºö
- Buy Agent Fine-tune: 1,250,000 Ê≠• (Ê®ôÊ∫ñ)
- Sell Agent Fine-tune: 500,000 Ê≠• (Ê®ôÊ∫ñ)

‰ΩúËÄÖÔºöPhil Liang (Generated by Gemini)
Êó•ÊúüÔºö2025-12-07
================================================================================
"""

import os
import sys
import glob
import shutil
import pickle

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'

import yfinance as yf
import pandas as pd

# =============================================================================
# Ë®≠ÂÆö
# =============================================================================
PROJECT_PATH = os.path.dirname(os.path.abspath(__file__))
CACHE_DIR = os.path.join(PROJECT_PATH, "data", "processed")
DATA_PATH = os.path.join(PROJECT_PATH, "data", "raw")
V4_MODELS_PATH = os.path.join(PROJECT_PATH, "models_hybrid_v4")
V4_RESULTS_PATH = os.path.join(PROJECT_PATH, "results_hybrid_v4")
SPLIT_DATE = '2023-01-01'

# V4: Ë®ìÁ∑¥Ê≠•Êï∏Ë®≠ÂÆö
PRETRAIN_BUY_STEPS = 1_000_000
PRETRAIN_SELL_STEPS = 500_000
FINETUNE_BUY_STEPS = 1_000_000
FINETUNE_SELL_STEPS = 500_000


def clear_cache():
    print("\n" + "=" * 60)
    print("Step A: Clear Cache")
    print("=" * 60)
    if not os.path.exists(CACHE_DIR):
        print(f"[Info] Cache dir not found: {CACHE_DIR}")
        return
    pkl_files = glob.glob(os.path.join(CACHE_DIR, "*.pkl"))
    if not pkl_files:
        print("[Info] No .pkl cache files found")
        return
    print(f"[Info] Found {len(pkl_files)} cache files")
    for f in pkl_files:
        try:
            os.remove(f)
            print(f"  Deleted: {os.path.basename(f)}")
        except Exception as e:
            print(f"  Failed: {os.path.basename(f)} - {e}")
    print("[Done] Cache cleared")


def run_pretraining():
    print("\n" + "=" * 60)
    print("Step B: Pre-training")
    print("=" * 60)
    print(f"  Buy Agent:  {PRETRAIN_BUY_STEPS:,} steps")
    print(f"  Sell Agent: {PRETRAIN_SELL_STEPS:,} steps")
    print(f"  Output:     {V4_MODELS_PATH}")
    print("=" * 60)
    
    os.makedirs(V4_MODELS_PATH, exist_ok=True)
    os.makedirs(DATA_PATH, exist_ok=True)
    
    import ptrl_hybrid_system as hybrid
    import torch
    device = "cuda" if torch.cuda.is_available() else "cpu"
    print(f"[System] Device: {device}")
    
    print("\n[System] Loading LSTM models...")
    hybrid.load_best_lstm_models()
    
    print("\n[Data] Downloading global index data...")
    raw_data = hybrid.fetch_index_data(DATA_PATH, start_date="2000-01-01", end_date=SPLIT_DATE)
    
    print("\n[Data] Computing features (30x MC Dropout)...")
    train_data = {}
    benchmark_df = raw_data.get("^TWII")
    for ticker, df in raw_data.items():
        try:
            processed = hybrid.calculate_features(df, benchmark_df, ticker, use_cache=False)
            if len(processed) > 100:
                train_data[ticker] = processed
                print(f"  OK {ticker}: {len(processed)} rows")
        except Exception as e:
            print(f"  WARN {ticker}: {e}")
    
    # Áç®Á´ãÊ™¢Êü• Buy Âíå Sell Agent
    buy_done = check_pretrain_buy_complete()
    sell_done = check_pretrain_sell_complete()
    
    print(f"\n[Training] Starting pre-training...")
    print(f"   Buy Agent:  {'‚è≠Ô∏è SKIP' if buy_done else '‚úÖ Train'}")
    print(f"   Sell Agent: {'‚è≠Ô∏è SKIP' if sell_done else '‚úÖ Train'}")
    
    hybrid.run_pretraining(train_data, V4_MODELS_PATH, device,
                            pretrain_buy_steps=PRETRAIN_BUY_STEPS,
                            pretrain_sell_steps=PRETRAIN_SELL_STEPS,
                            train_buy=not buy_done,
                            train_sell=not sell_done)
    print(f"\n[Done] Pre-training complete! Saved to {V4_MODELS_PATH}/")


def run_finetuning(train_buy=True, train_sell=True):
    print("\n" + "=" * 60)
    print("Step C: Fine-tuning (Standard)")
    print("=" * 60)
    print(f"  Buy Agent:  {FINETUNE_BUY_STEPS:,} steps (Ê®ôÊ∫ñ) {'‚úÖ' if train_buy else '‚è≠Ô∏è SKIP'}")
    print(f"  Sell Agent: {FINETUNE_SELL_STEPS:,} steps (Ê®ôÊ∫ñ) {'‚úÖ' if train_sell else '‚è≠Ô∏è SKIP'}")
    print(f"  Output:     {V4_MODELS_PATH}")
    print("=" * 60)
    
    import ptrl_hybrid_system as hybrid
    import torch
    device = "cuda" if torch.cuda.is_available() else "cpu"
    print(f"[System] Device: {device}")
    
    hybrid.load_best_lstm_models()
    
    print("\n[Data] Preparing ^TWII data...")
    cache_path = os.path.join(CACHE_DIR, "_TWII_features.pkl")
    
    if os.path.exists(cache_path):
        print(f"[Cache] Loading ^TWII features...")
        with open(cache_path, 'rb') as f:
            twii_full_df = pickle.load(f)
    else:
        print("[Compute] Loading ^TWII from local CSV...")
        # [Modify] ‰ΩøÁî®Êú¨Âú∞Ë≥áÊñôËºâÂÖ•ÂáΩÊï∏
        twii_raw = hybrid._load_local_twii_data(start_date="2000-01-01")
        
        twii_full_df = hybrid.calculate_features(twii_raw, twii_raw, ticker="^TWII", use_cache=True)
    
    print(f"[Data] ^TWII data: {len(twii_full_df)} rows")
    
    split_date = pd.Timestamp(SPLIT_DATE)
    twii_finetune_df = twii_full_df[twii_full_df.index < split_date]
    twii_eval_df = twii_full_df[twii_full_df.index >= split_date]
    
    print(f"  Fine-tuning set: {len(twii_finetune_df)} rows (< {SPLIT_DATE})")
    print(f"  Eval set:        {len(twii_eval_df)} rows (>= {SPLIT_DATE})")
    
    finetune_data = {'^TWII': twii_finetune_df}
    eval_data = {'^TWII': twii_eval_df}
    
    print(f"\n[Training] Starting fine-tuning...")
    hybrid.run_finetuning(finetune_data, eval_data, V4_MODELS_PATH, device,
                          finetune_buy_steps=FINETUNE_BUY_STEPS,
                          finetune_sell_steps=FINETUNE_SELL_STEPS,
                          train_buy=train_buy,
                          train_sell=train_sell)
    print(f"\n[Done] Fine-tuning complete! Saved to {V4_MODELS_PATH}/")


def print_next_steps():
    print("\n" + "=" * 60)
    print("‚úÖ V4 Ê®°ÂûãË®ìÁ∑¥ÊµÅÁ®ãÂ∑≤ÂÆåÊàêÔºÅ")
    print("=" * 60)
    print(f"""
üìÅ Ê®°ÂûãÂÑ≤Â≠ò‰ΩçÁΩÆ:
   {V4_MODELS_PATH}/ppo_buy_twii_final.zip
   {V4_MODELS_PATH}/ppo_sell_twii_final.zip

üìä V4 ÁâπÈªû (Ê®ôÊ∫ñÂÆåÊï¥Áâà):
   - Buy Fine-tune: 1,250,000 steps
   - Sell Fine-tune: 500,000 steps

üí° daily_ops_dual.py Â∑≤È†êË®≠‰ΩøÁî® V3 Âíå V4 Ê®°ÂûãÈÄ≤Ë°åÈõôÁ≠ñÁï•Êé®Ë´ñ
""")


def check_pretrain_buy_complete():
    buy_base = os.path.join(V4_MODELS_PATH, "ppo_buy_base.zip")
    return os.path.exists(buy_base)


def check_pretrain_sell_complete():
    sell_base = os.path.join(V4_MODELS_PATH, "ppo_sell_base.zip")
    return os.path.exists(sell_base)


def check_pretrain_complete():
    return check_pretrain_buy_complete() and check_pretrain_sell_complete()


def check_finetune_buy_complete():
    buy_final = os.path.join(V4_MODELS_PATH, "ppo_buy_twii_final.zip")
    return os.path.exists(buy_final)


def check_finetune_sell_complete():
    sell_final = os.path.join(V4_MODELS_PATH, "ppo_sell_twii_final.zip")
    return os.path.exists(sell_final)


def check_finetune_complete():
    return check_finetune_buy_complete() and check_finetune_sell_complete()


def check_backtest_complete():
    result_chart = os.path.join(V4_RESULTS_PATH, "final_performance.png")
    return os.path.exists(result_chart)


def run_backtesting_step():
    print("\n" + "=" * 60)
    print("Step D: Backtesting")
    print("=" * 60)
    print(f"  Output: {V4_RESULTS_PATH}")
    print("=" * 60)
    
    os.makedirs(V4_RESULTS_PATH, exist_ok=True)
    
    import ptrl_hybrid_system as hybrid
    from stable_baselines3 import PPO
    
    hybrid.load_best_lstm_models()
    
    print("\n[Data] Preparing ^TWII data...")
    # [v4.0] Âº∑Âà∂ÈáçÁÆóÁâπÂæµÔºåÁ¢∫‰øù LSTM_Pred_20d Á≠âÁâπÂæµËàáËºâÂÖ•ÁöÑÊ®°Âûã‰∏ÄËá¥
    print("[Compute] Loading ^TWII from local CSV (always recalculate)...")
    twii_raw = hybrid._load_local_twii_data(start_date="2000-01-01")
    twii_full_df = hybrid.calculate_features(twii_raw, twii_raw, ticker="^TWII", use_cache=False)
    
    split_date = pd.Timestamp(SPLIT_DATE)
    twii_backtest_df = twii_full_df[twii_full_df.index >= split_date]
    
    print(f"[Data] Backtest period: {twii_backtest_df.index[0].strftime('%Y-%m-%d')} ~ {twii_backtest_df.index[-1].strftime('%Y-%m-%d')}")
    print(f"[Data] Backtest data: {len(twii_backtest_df)} rows")
    
    print("\n[Model] Loading V4 Fine-tuned models...")
    buy_model = PPO.load(os.path.join(V4_MODELS_PATH, "ppo_buy_twii_final.zip"))
    sell_model = PPO.load(os.path.join(V4_MODELS_PATH, "ppo_sell_twii_final.zip"))
    
    print("\n[Backtest] Running...")
    metrics = hybrid.run_backtesting(twii_backtest_df, buy_model, sell_model, V4_RESULTS_PATH, twii_full_df)
    
    print(f"\n[Done] Backtest complete! Results saved to {V4_RESULTS_PATH}/")
    return metrics


def main():
    print("=" * 60)
    print("V4 Model Training Script (Standard Fine-tuning)")
    print(f"   Buy Fine-tune: {FINETUNE_BUY_STEPS:,} steps | Sell Fine-tune: {FINETUNE_SELL_STEPS:,} steps")
    print("=" * 60)
    
    # Áç®Á´ãÊ™¢Êü• Buy Âíå Sell Base Ê®°Âûã
    buy_base_done = check_pretrain_buy_complete()
    sell_base_done = check_pretrain_sell_complete()
    
    if not (buy_base_done and sell_base_done):
        clear_cache()
    else:
        print("\n[Skip] Step A: Cache clearing (pre-training done)")
    
    if buy_base_done and sell_base_done:
        print("\n" + "=" * 60)
        print("[Skip] Step B: Pre-training complete")
        print(f"   Buy Base:  {V4_MODELS_PATH}/ppo_buy_base.zip ‚úÖ")
        print(f"   Sell Base: {V4_MODELS_PATH}/ppo_sell_base.zip ‚úÖ")
        print("=" * 60)
    else:
        print("\n" + "=" * 60)
        print("[Check] Step B: Pre-training status")
        print(f"   Buy Base:  {'‚úÖ Done' if buy_base_done else '‚ùå Missing'}")
        print(f"   Sell Base: {'‚úÖ Done' if sell_base_done else '‚ùå Missing'}")
        print("=" * 60)
        run_pretraining()
    
    # Áç®Á´ãÊ™¢Êü• Buy Âíå Sell Agent
    buy_done = check_finetune_buy_complete()
    sell_done = check_finetune_sell_complete()
    
    if buy_done and sell_done:
        print("\n" + "=" * 60)
        print("[Skip] Step C: Fine-tuning complete")
        print(f"   Buy Final:  {V4_MODELS_PATH}/ppo_buy_twii_final.zip ‚úÖ")
        print(f"   Sell Final: {V4_MODELS_PATH}/ppo_sell_twii_final.zip ‚úÖ")
        print("=" * 60)
    else:
        print("\n" + "=" * 60)
        print("[Check] Step C: Fine-tuning status")
        print(f"   Buy Final:  {'‚úÖ Done' if buy_done else '‚ùå Missing'}")
        print(f"   Sell Final: {'‚úÖ Done' if sell_done else '‚ùå Missing'}")
        print("=" * 60)
        run_finetuning(train_buy=not buy_done, train_sell=not sell_done)
    
    if check_backtest_complete():
        print("\n" + "=" * 60)
        print("[Skip] Step D: Backtest complete")
        print(f"   Result: {V4_RESULTS_PATH}/final_performance.png")
        print("=" * 60)
    else:
        run_backtesting_step()
    
    print_next_steps()


if __name__ == "__main__":
    main()
